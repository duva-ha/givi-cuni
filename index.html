// --- LOGIC CẬP NHẬT DANH SÁCH & CỘNG ĐIỂM ---
const AdminApp = () => {
    const [students, setStudents] = React.useState([]);

    // 1. Tự động tải danh sách học sinh từ Firebase khi mở trang
    React.useEffect(() => {
        const unsubscribe = db.collection("students").orderBy("group").onSnapshot(snapshot => {
            setStudents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return () => unsubscribe();
    }, []);

    // 2. Hàm cộng điểm XP cho học sinh
    const addXP = async (studentId, points, actionName) => {
        const studentRef = db.collection("students").doc(studentId);
        
        try {
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(studentRef);
                const currentXp = doc.data().totalXp || 0;
                const newXp = currentXp + points;
                const newLevel = Math.floor(newXp / 500) + 1; // 500 XP lên 1 Level

                transaction.update(studentRef, {
                    totalXp: newXp,
                    level: newLevel
                });

                // Lưu lịch sử để học sinh xem lại
                db.collection("xp_logs").add({
                    studentId,
                    action: actionName,
                    points: points,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            alert(`Đã cộng ${points} XP cho ${doc.data().name}`);
        } catch (e) {
            console.error("Lỗi cộng điểm: ", e);
        }
    };

    return (
        <div className="p-6">
            {students.map(s => (
                <div key={s.id} className="flex justify-between p-4 mb-2 bg-slate-800 rounded-lg">
                    <span>{s.name} (Tổ {s.group}) - Lv.{s.level}</span>
                    <div className="flex gap-2">
                        <button onClick={() => addXP(s.id, 10, "Phát biểu")} className="bg-blue-600 px-3 rounded">+10 XP</button>
                        <button onClick={() => addXP(s.id, 30, "Trực nhật")} className="bg-green-600 px-3 rounded">+30 XP</button>
                    </div>
                </div>
            ))}
        </div>
    );
};
