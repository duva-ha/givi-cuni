<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10A7 Admin Hub - XP Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Serif+SC:wght@900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f1f5f9; }
        .luxury-panel { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(212, 175, 55, 0.3); border-left: 4px solid #d4af37; }
        .gold-text { background: linear-gradient(180deg, #fde68a 0%, #d4af37 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .chinese-title { font-family: 'Noto Serif SC', serif; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDQmerSSs0qhO01xNnFWpquZYseDThWxP0",
            authDomain: "lichtruc-e3f82.firebaseapp.com",
            projectId: "lichtruc-e3f82",
            storageBucket: "lichtruc-e3f82.firebasestorage.app",
            messagingSenderId: "476557236437",
            appId: "1:476557236437:web:dfb1cb5848642daecdaa5c"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const AdminApp = () => {
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");

            // 1. Đồng bộ danh sách 47 học sinh real-time
            useEffect(() => {
                const unsubscribe = db.collection("students").orderBy("group").onSnapshot(s => {
                    setStudents(s.docs.map(d => ({id: d.id, ...d.data()})));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Logic cộng/trừ XP thông minh
            const handleXP = async (studentId, points, reason) => {
                const studentRef = db.collection("students").doc(studentId);
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(studentRef);
                    const newXp = (doc.data().totalXp || 0) + points;
                    const newLevel = Math.floor(newXp / 500) + 1; // Level Up

                    transaction.update(studentRef, {
                        totalXp: newXp,
                        level: newLevel,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Ghi log lịch sử công khai
                    db.collection("xp_logs").add({
                        studentId,
                        studentName: doc.data().name,
                        action: reason,
                        points: points,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
            };

            const filteredStudents = students.filter(s => 
                s.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <header className="flex justify-between items-center mb-10 border-b border-white/10 pb-6">
                        <div>
                            <h1 className="chinese-title text-4xl gold-text">10A7 // COMMAND CENTER</h1>
                            <p className="text-[10px] uppercase tracking-[0.3em] opacity-50">Quyền truy cập: Giáo viên chủ nhiệm</p>
                        </div>
                        <div className="text-right">
                            <p className="text-xs font-bold text-cyan-400">STATUS: ENCRYPTED</p>
                            <p className="text-[10px] opacity-40 uppercase">{new Date().toLocaleDateString('vi-VN')}</p>
                        </div>
                    </header>

                    {/* Bộ lọc tìm kiếm học sinh */}
                    <div className="mb-8">
                        <input 
                            type="text" 
                            placeholder="TÌM TÊN HỌC SINH..." 
                            className="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-[#d4af37] transition-all"
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    {/* Danh sách quản lý */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {filteredStudents.map(s => (
                            <div key={s.id} className="luxury-panel p-5 flex justify-between items-center animate-fade-up">
                                <div>
                                    <h3 className="text-lg font-black uppercase tracking-tight">{s.name}</h3>
                                    <p className="text-[10px] opacity-50 uppercase font-bold">
                                        Tổ {s.group} | Level {s.level || 1} | {s.totalXp || 0} XP
                                    </p>
                                </div>
                                
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => handleXP(s.id, 10, 'Phát biểu')}
                                        className="w-10 h-10 rounded-lg bg-blue-600/20 text-blue-400 border border-blue-600/30 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all"
                                        title="Phát biểu +10XP"
                                    >
                                        <i className="fa-solid fa-microphone-lines"></i>
                                    </button>
                                    <button 
                                        onClick={() => handleXP(s.id, 30, 'Trực nhật tốt')}
                                        className="w-10 h-10 rounded-lg bg-green-600/20 text-green-400 border border-green-600/30 flex items-center justify-center hover:bg-green-600 hover:text-white transition-all"
                                        title="Trực nhật +30XP"
                                    >
                                        <i className="fa-solid fa-broom"></i>
                                    </button>
                                    <button 
                                        onClick={() => handleXP(s.id, -20, 'Vi phạm nội quy')}
                                        className="w-10 h-10 rounded-lg bg-red-600/20 text-red-400 border border-red-500/30 flex items-center justify-center hover:bg-red-600 hover:text-white transition-all"
                                        title="Vi phạm -20XP"
                                    >
                                        <i className="fa-solid fa-triangle-exclamation"></i>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Nhật ký hành động nhanh */}
                    <div className="mt-12 opacity-50 italic text-[10px] text-center uppercase tracking-widest">
                        Mọi thay đổi sẽ được đồng bộ trực tiếp lên hệ thống học sinh
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
